<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pawtektado - Pet Care Companion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* Light blue-gray background */
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            border-color: #3b82f6; /* Blue-500 */
            color: #3b82f6;
            background-color: #eff6ff; /* Blue-50 */
        }
        .card {
            background-color: white;
            border-radius: 0.75rem; /* 12px */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: box-shadow 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .modal {
            display: none; /* Hidden by default */
        }
        .modal.show {
            display: flex; /* Show when active */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* cool-gray-300 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; /* cool-gray-400 */
        }
        .list-item {
            background-color: #f9fafb; /* gray-50 */
            padding: 0.75rem 1rem; /* p-3 p-4 */
            border-radius: 0.5rem; /* rounded-md */
            border: 1px solid #e5e7eb; /* border-gray-200 */
        }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-600">üêæ Pawtektado</h1>
            <p class="text-gray-600 mt-2">Your Pet Care Companion. Manage needs, bookings, and history with ease.</p>
        </header>

        <nav class="mb-8">
            <div class="flex border-b border-gray-300 flex-wrap">
                <button id="tabMyPets" class="tab-button flex-1 py-3 px-2 md:px-4 text-sm md:text-base text-center font-semibold text-gray-600 hover:bg-gray-100 focus:outline-none active" onclick="showSection('myPetsSection')">My Pets</button>
                <button id="tabAddPet" class="tab-button flex-1 py-3 px-2 md:px-4 text-sm md:text-base text-center font-semibold text-gray-600 hover:bg-gray-100 focus:outline-none" onclick="showSection('addPetSection')">Add Pet</button>
                <button id="tabBookings" class="tab-button flex-1 py-3 px-2 md:px-4 text-sm md:text-base text-center font-semibold text-gray-600 hover:bg-gray-100 focus:outline-none" onclick="showSection('bookingsSection')">Bookings</button>
                <button id="tabPetHistory" class="tab-button flex-1 py-3 px-2 md:px-4 text-sm md:text-base text-center font-semibold text-gray-600 hover:bg-gray-100 focus:outline-none" onclick="showSection('petHistorySection')">Pet History</button>
                <button id="tabProviders" class="tab-button flex-1 py-3 px-2 md:px-4 text-sm md:text-base text-center font-semibold text-gray-600 hover:bg-gray-100 focus:outline-none" onclick="showSection('providersSection')">Providers</button>
            </div>
        </nav>

        <section id="myPetsSection" class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">My Pets</h2>
            <div id="petsListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
            <p id="noPetsMessage" class="text-gray-500 text-center py-4 hidden">You haven't added any pets yet. Click 'Add Pet' to get started!</p>
        </section>

        <section id="addPetSection" class="hidden space-y-6 card p-6 md:p-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Add a New Pet</h2>
            <form id="addPetForm" class="space-y-4">
                <div>
                    <label for="petName" class="block text-sm font-medium text-gray-700">Pet's Name</label>
                    <input type="text" id="petName" name="petName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="petBreed" class="block text-sm font-medium text-gray-700">Breed / Species</label>
                    <input type="text" id="petBreed" name="petBreed" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="petAge" class="block text-sm font-medium text-gray-700">Age (e.g., 2 years, 5 months)</label>
                    <input type="text" id="petAge" name="petAge" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <div>
                    <label for="petPhoto" class="block text-sm font-medium text-gray-700">Photo URL (Optional)</label>
                    <input type="url" id="petPhoto" name="petPhoto" placeholder="https://example.com/your-pet.jpg" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150">Add Pet</button>
            </form>
        </section>

        <section id="petDetailsSection" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50 modal">
            <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto card">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="detailsPetName" class="text-3xl font-bold text-blue-600"></h2>
                    <button onclick="closePetDetails()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <img id="detailsPetPhoto" src="https://placehold.co/300x200/e2e8f0/94a3b8?text=Pet+Photo" alt="Pet Photo" class="rounded-lg object-cover w-full h-48 md:h-64 mb-2">
                        <p class="text-sm text-gray-500"><strong>Breed:</strong> <span id="detailsPetBreed"></span></p>
                        <p class="text-sm text-gray-500"><strong>Age:</strong> <span id="detailsPetAge"></span></p>
                    </div>
                    <div id="petNeedsContainer" class="space-y-3">
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Needs & Reminders</h3>
                        <div id="needsList" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                            </div>
                        <p id="noNeedsMessage" class="text-gray-500 text-sm hidden">No needs recorded yet.</p>
                    </div>
                </div>
                
                <form id="addNeedForm" class="space-y-3 border-t pt-4">
                    <input type="hidden" id="currentPetId">
                    <h4 class="text-lg font-semibold text-gray-700">Add New Need/Reminder</h4>
                    <div>
                        <label for="needDescription" class="block text-sm font-medium text-gray-700">Description (e.g., Vet Appointment, Vaccination)</label>
                        <input type="text" id="needDescription" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="needDate" class="block text-sm font-medium text-gray-700">Date & Time</label>
                        <input type="datetime-local" id="needDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </div>
                     <div>
                        <label for="needProvider" class="block text-sm font-medium text-gray-700">Service Provider (Optional)</label>
                        <select id="needProvider" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            <option value="">None</option>
                            </select>
                    </div>
                    <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">Add Need</button>
                </form>
                 <button onclick="handleDeletePet()" id="deletePetButton" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150">Delete This Pet</button>
            </div>
        </section>

        <section id="bookingsSection" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Current Bookings</h2>
            <div id="bookingsListContainer" class="space-y-4">
                </div>
            <p id="noBookingsMessage" class="text-gray-500 text-center py-4 hidden">No current bookings found.</p>
        </section>

        <section id="petHistorySection" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Pet History</h2>
            <div id="petHistoryListContainer" class="space-y-4">
                </div>
            <p id="noHistoryMessage" class="text-gray-500 text-center py-4 hidden">No pet history found.</p>
        </section>

        <section id="providersSection" class="hidden space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Service Providers</h2>
            <p class="text-sm text-gray-600 mb-4">Connect with local vets and pet service providers. (Sample Data)</p>
            <div id="providersListContainer" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                </div>
        </section>

        <div id="messageModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center card">
                <p id="modalMessageText" class="text-lg mb-4"></p>
                <button onclick="closeMessageModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">OK</button>
            </div>
        </div>
        
        <div id="confirmationModal" class="modal fixed inset-0 bg-gray-800 bg-opacity-75 items-center justify-center p-4 z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center card">
                <p id="confirmationMessageText" class="text-lg mb-4"></p>
                <div class="flex justify-center space-x-4">
                    <button id="confirmActionButton" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">Confirm</button>
                    <button id="cancelActionButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-2 px-6 rounded-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Cancel</button>
                </div>
            </div>
        </div>

    </div>

    <footer class="text-center py-8 mt-12 border-t border-gray-300">
        <p class="text-gray-500 text-sm">&copy; <span id="currentYear"></span> Pawtektado. Happy Pets, Happy Life!</p>
    </footer>

    <script>
        // --- DOM Elements ---
        const sections = {
            myPets: document.getElementById('myPetsSection'),
            addPet: document.getElementById('addPetSection'),
            petDetails: document.getElementById('petDetailsSection'),
            providers: document.getElementById('providersSection'),
            bookings: document.getElementById('bookingsSection'), // New
            petHistory: document.getElementById('petHistorySection') // New
        };
        const tabs = {
            myPets: document.getElementById('tabMyPets'),
            addPet: document.getElementById('tabAddPet'),
            providers: document.getElementById('tabProviders'),
            bookings: document.getElementById('tabBookings'), // New
            petHistory: document.getElementById('tabPetHistory') // New
        };

        const addPetForm = document.getElementById('addPetForm');
        const petsListContainer = document.getElementById('petsListContainer');
        const noPetsMessage = document.getElementById('noPetsMessage');
        
        const detailsPetName = document.getElementById('detailsPetName');
        const detailsPetPhoto = document.getElementById('detailsPetPhoto');
        const detailsPetBreed = document.getElementById('detailsPetBreed');
        const detailsPetAge = document.getElementById('detailsPetAge');
        // const petNeedsContainer = document.getElementById('petNeedsContainer'); // Already declared
        const needsList = document.getElementById('needsList');
        const noNeedsMessage = document.getElementById('noNeedsMessage'); // For needs within pet details
        const addNeedForm = document.getElementById('addNeedForm');
        const currentPetIdInput = document.getElementById('currentPetId');
        const needProviderSelect = document.getElementById('needProvider'); // For selecting provider in add need form
        // const deletePetButton = document.getElementById('deletePetButton'); // Already declared

        const providersListContainer = document.getElementById('providersListContainer');
        const bookingsListContainer = document.getElementById('bookingsListContainer'); // New
        const noBookingsMessage = document.getElementById('noBookingsMessage'); // New
        const petHistoryListContainer = document.getElementById('petHistoryListContainer'); // New
        const noHistoryMessage = document.getElementById('noHistoryMessage'); // New
        
        const messageModal = document.getElementById('messageModal');
        const modalMessageText = document.getElementById('modalMessageText');

        const confirmationModal = document.getElementById('confirmationModal'); // New
        const confirmationMessageText = document.getElementById('confirmationMessageText'); // New
        const confirmActionButton = document.getElementById('confirmActionButton'); // New
        const cancelActionButton = document.getElementById('cancelActionButton'); // New
        let currentConfirmAction = null; // New for confirmation modal callback

        document.getElementById('currentYear').textContent = new Date().getFullYear();

        // --- Data Storage (localStorage) ---
        let pets = []; // Will be populated from localStorage or with samples
        let currentEditingPetId = null;

        // --- Sample Provider Data ---
        const serviceProviders = [
            { 
                id: 'vet1', 
                name: 'Happy Paws Veterinary Clinic', 
                type: 'Veterinarian', 
                phone: '555-0101', 
                email: 'contact@happypawsvet.example.com', 
                address: '123 Vet Street, Anytown',
                services: ['Checkups', 'Vaccinations', 'Surgery', 'Dental Care']
            },
            { 
                id: 'groomer1', 
                name: 'Pristine Pups Grooming', 
                type: 'Groomer', 
                phone: '555-0202', 
                email: 'info@pristinepups.example.com', 
                address: '456 Groomer Ave, Anytown',
                services: ['Bathing', 'Haircuts', 'Nail Trimming', 'De-shedding']
            },
            { 
                id: 'walker1', 
                name: 'Walky Paws Dog Walking', 
                type: 'Dog Walker', 
                phone: '555-0303', 
                email: 'bookings@walkypaws.example.com', 
                address: '789 Park Road, Anytown',
                services: ['Group Walks', 'Solo Walks', 'Pet Sitting (short)']
            },
             { 
                id: 'vet2', 
                name: 'Healthy Tails Animal Hospital', 
                type: 'Veterinarian', 
                phone: '555-0105', 
                email: 'reception@healthytails.example.com', 
                address: '321 Health Blvd, Anytown',
                services: ['Emergency Care', 'Diagnostics', 'Wellness Exams', 'Nutrition Counseling']
            }
        ];
        
        // --- Sample Pet Data (if localStorage is empty) ---
        const samplePets = [
            {
                id: 'pet_sample1_bantay',
                name: 'Bantay',
                breed: 'Aspin (Philippine Native Dog)',
                age: '3 years',
                photo: 'https://placehold.co/300x200/60a5fa/ffffff?text=Bantay',
                needs: [
                    { id: 'need_sample1_1', description: 'Annual Checkup', date: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().slice(0,16), providerId: 'vet1', status: 'Confirmed' }, // Approx 15 days from now
                    { id: 'need_sample1_2', description: 'Grooming Session', date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0,16), providerId: 'groomer1', status: 'Pending' }, // Approx 30 days from now
                    { id: 'need_sample1_3', description: 'Rabies Vaccination', date: new Date(Date.now() - 60 * 24 * 60 * 60 * 1000).toISOString().slice(0,16), providerId: 'vet1', status: 'Completed' } // Approx 60 days ago
                ]
            },
            {
                id: 'pet_sample2_muning',
                name: 'Muning',
                breed: 'Puspin (Philippine Shorthair Cat)',
                age: '1 year 6 months',
                photo: 'https://placehold.co/300x200/f472b6/ffffff?text=Muning',
                needs: [
                    { id: 'need_sample2_1', description: 'Vaccination Booster', date: new Date(Date.now() + 45 * 24 * 60 * 60 * 1000).toISOString().slice(0,16), providerId: 'vet2', status: 'Confirmed' }, // Approx 45 days from now
                    { id: 'need_sample2_2', description: 'Deworming', date: new Date(Date.now() - 90 * 24 * 60 * 60 * 1000).toISOString().slice(0,16), providerId: 'vet2', status: 'Completed' } // Approx 90 days ago
                ]
            }
        ];


        // --- Functions ---

        // Show/Hide Sections (Tab Functionality)
        function showSection(sectionId) {
            Object.values(sections).forEach(section => section.classList.add('hidden'));
            Object.values(tabs).forEach(tab => tab.classList.remove('active'));
            
            const targetSection = sections[sectionId] || document.getElementById(sectionId);
            const targetTab = tabs[sectionId];

            if (targetSection) {
                targetSection.classList.remove('hidden');
                if (sectionId === 'petDetailsSection') {
                    targetSection.classList.add('show'); // Special class for modal display
                }
            }
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // If navigating away from pet details, ensure it's properly hidden
            if (sectionId !== 'petDetailsSection' && sections.petDetails.classList.contains('show')) {
                sections.petDetails.classList.remove('show');
                sections.petDetails.classList.add('hidden');
            }
        }
        
        // Message Modal
        function showMessageModal(message) {
            modalMessageText.textContent = message;
            messageModal.classList.add('show');
        }

        function closeMessageModal() {
            messageModal.classList.remove('show');
        }

        // Confirmation Modal Functions
        function showConfirmationModal(message, onConfirmCallback) {
            confirmationMessageText.textContent = message;
            currentConfirmAction = onConfirmCallback;
            confirmationModal.classList.add('show');
        }

        function closeConfirmationModal() {
            confirmationModal.classList.remove('show');
            currentConfirmAction = null;
        }

        confirmActionButton.addEventListener('click', () => {
            if (typeof currentConfirmAction === 'function') {
                currentConfirmAction();
            }
            closeConfirmationModal();
        });

        cancelActionButton.addEventListener('click', () => {
            closeConfirmationModal();
        });


        // Save pets to localStorage
        function savePets() {
            localStorage.setItem('pets', JSON.stringify(pets));
            // Re-render lists that depend on pets data
            renderBookingsList();
            renderPetHistoryList();
        }

        // Render Pets List
        function renderPetsList() {
            petsListContainer.innerHTML = ''; 
            if (pets.length === 0) {
                noPetsMessage.classList.remove('hidden');
                return;
            }
            noPetsMessage.classList.add('hidden');

            pets.forEach(pet => {
                const petCard = document.createElement('div');
                petCard.className = 'card p-4 flex items-start space-x-4 cursor-pointer hover:bg-gray-50';
                petCard.onclick = () => viewPetDetails(pet.id);

                const petPhotoUrl = pet.photo || `https://placehold.co/80x80/e0e7ff/4f46e5?text=${pet.name.substring(0,1)}`;
                
                petCard.innerHTML = `
                    <img src="${petPhotoUrl}" alt="${pet.name}" class="w-20 h-20 rounded-full object-cover border-2 border-blue-200" onerror="this.onerror=null;this.src='https://placehold.co/80x80/e2e8f0/94a3b8?text=Pet';">
                    <div>
                        <h3 class="text-xl font-semibold text-blue-600">${pet.name}</h3>
                        <p class="text-sm text-gray-600">${pet.breed}</p>
                        ${pet.age ? `<p class="text-sm text-gray-500">Age: ${pet.age}</p>` : ''}
                    </div>
                `;
                petsListContainer.appendChild(petCard);
            });
        }

        // Add New Pet
        addPetForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const newPet = {
                id: 'pet_' + Date.now(),
                name: addPetForm.petName.value,
                breed: addPetForm.petBreed.value,
                age: addPetForm.petAge.value,
                photo: addPetForm.petPhoto.value,
                needs: [] 
            };
            pets.push(newPet);
            savePets();
            renderPetsList();
            addPetForm.reset();
            showMessageModal(`${newPet.name} has been added successfully!`);
            showSection('myPets'); 
        });
        
        // Populate provider dropdown in "Add Need" form
        function populateProviderDropdown() {
            needProviderSelect.innerHTML = '<option value="">None</option>'; // Clear existing and add default
            serviceProviders.forEach(provider => {
                const option = document.createElement('option');
                option.value = provider.id;
                option.textContent = provider.name;
                needProviderSelect.appendChild(option);
            });
        }


        // View Pet Details
        function viewPetDetails(petId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet) return;

            currentEditingPetId = pet.id; 
            currentPetIdInput.value = pet.id; 

            detailsPetName.textContent = pet.name;
            detailsPetPhoto.src = pet.photo || `https://placehold.co/300x200/e0e7ff/4f46e5?text=${pet.name}`;
            detailsPetPhoto.onerror = function() { this.src = 'https://placehold.co/300x200/e2e8f0/94a3b8?text=Pet+Photo'; };
            detailsPetBreed.textContent = pet.breed;
            detailsPetAge.textContent = pet.age || 'N/A';
            
            populateProviderDropdown(); // Populate providers for the add need form
            renderPetNeeds(pet.id);
            showSection('petDetailsSection');
        }
        
        // Close Pet Details Modal
        function closePetDetails() {
            sections.petDetails.classList.remove('show');
            sections.petDetails.classList.add('hidden');
            currentEditingPetId = null;
        }

        // Handle Delete Pet (shows confirmation)
        function handleDeletePet() {
            if (!currentEditingPetId) return;
            const pet = pets.find(p => p.id === currentEditingPetId);
            if (!pet) return;

            showConfirmationModal(`Are you sure you want to delete ${pet.name}? This action cannot be undone.`, () => {
                actuallyDeletePet();
            });
        }

        // Actually Delete Pet (called by confirmation)
        function actuallyDeletePet() {
            if (!currentEditingPetId) return;
            pets = pets.filter(pet => pet.id !== currentEditingPetId);
            savePets();
            renderPetsList();
            closePetDetails();
            showMessageModal('Pet deleted successfully.');
            showSection('myPets');
        }


        // Render Pet Needs (in Pet Details modal)
        function renderPetNeeds(petId) {
            const pet = pets.find(p => p.id === petId);
            needsList.innerHTML = ''; 

            if (!pet || !pet.needs || pet.needs.length === 0) {
                noNeedsMessage.classList.remove('hidden');
                return;
            }
            noNeedsMessage.classList.add('hidden');

            const sortedNeeds = [...pet.needs].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedNeeds.forEach(need => {
                const needElement = document.createElement('div');
                needElement.className = 'p-3 bg-indigo-50 rounded-md border border-indigo-200 flex justify-between items-center';
                
                const needDate = new Date(need.date);
                const formattedDate = `${needDate.toLocaleDateString()} ${needDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                let providerName = '';
                if (need.providerId) {
                    const provider = serviceProviders.find(p => p.id === need.providerId);
                    if (provider) providerName = ` <span class="text-xs text-indigo-400">(@ ${provider.name})</span>`;
                }

                needElement.innerHTML = `
                    <div>
                        <p class="font-medium text-indigo-700">${need.description}${providerName}</p>
                        <p class="text-xs text-indigo-500">${formattedDate}</p>
                    </div>
                    <button onclick="deleteNeed('${pet.id}', '${need.id}')" class="text-red-500 hover:text-red-700 text-xs font-semibold">Remove</button>
                `;
                needsList.appendChild(needElement);
            });
        }

        // Add New Need for a Pet
        addNeedForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const petId = currentPetIdInput.value; 
            if (!petId) {
                showMessageModal('Error: Could not find pet to add need to.');
                return;
            }

            const pet = pets.find(p => p.id === petId);
            if (!pet) {
                showMessageModal('Error: Pet not found.');
                return;
            }

            const newNeed = {
                id: 'need_' + Date.now(),
                description: addNeedForm.needDescription.value,
                date: addNeedForm.needDate.value,
                providerId: addNeedForm.needProvider.value || null, // Get provider ID
                status: 'Pending' // Default status for new needs
            };

            if (!pet.needs) {
                pet.needs = []; 
            }
            pet.needs.push(newNeed);
            savePets(); // This will also trigger re-render of bookings/history
            renderPetNeeds(pet.id);
            addNeedForm.reset();
            showMessageModal('Need added successfully!');
        });

        // Delete Need
        function deleteNeed(petId, needId) {
            const pet = pets.find(p => p.id === petId);
            if (!pet || !pet.needs) return;

            pet.needs = pet.needs.filter(need => need.id !== needId);
            savePets(); // This will also trigger re-render of bookings/history
            renderPetNeeds(petId); 
            showMessageModal('Need removed.');
        }

        // Render Service Providers
        function renderProviders() {
            providersListContainer.innerHTML = ''; 
            serviceProviders.forEach(provider => {
                const providerCard = document.createElement('div');
                providerCard.className = 'card p-6 space-y-3';
                
                let servicesHTML = provider.services.map(service => `<span class="inline-block bg-gray-200 text-gray-700 text-xs font-medium mr-2 mb-2 px-2.5 py-0.5 rounded-full">${service}</span>`).join('');

                providerCard.innerHTML = `
                    <h3 class="text-xl font-semibold text-green-600">${provider.name}</h3>
                    <p class="text-sm font-medium text-gray-500">${provider.type}</p>
                    <p class="text-sm text-gray-600"><span class="font-medium">Address:</span> ${provider.address || 'N/A'}</p>
                    <div class="mt-2">
                        <h4 class="text-xs font-semibold text-gray-500 uppercase mb-1">Services:</h4>
                        ${servicesHTML || '<p class="text-xs text-gray-500">N/A</p>'}
                    </div>
                    <div class="mt-4 space-x-2 border-t pt-3">
                        ${provider.phone ? `<a href="tel:${provider.phone}" class="inline-block bg-blue-500 hover:bg-blue-600 text-white text-sm font-semibold py-2 px-3 rounded-md transition duration-150">Call: ${provider.phone}</a>` : ''}
                        ${provider.email ? `<a href="mailto:${provider.email}" class="inline-block bg-teal-500 hover:bg-teal-600 text-white text-sm font-semibold py-2 px-3 rounded-md transition duration-150">Email</a>` : ''}
                    </div>
                `;
                providersListContainer.appendChild(providerCard);
            });
        }

        // Render Current Bookings List
        function renderBookingsList() {
            bookingsListContainer.innerHTML = '';
            let hasBookings = false;
            const now = new Date();

            pets.forEach(pet => {
                if (pet.needs && pet.needs.length > 0) {
                    pet.needs.forEach(need => {
                        const needDate = new Date(need.date);
                        // Show if it has a providerId and the date is in the future
                        if (need.providerId && needDate > now) {
                            hasBookings = true;
                            const provider = serviceProviders.find(p => p.id === need.providerId);
                            const bookingItem = document.createElement('div');
                            bookingItem.className = 'list-item flex justify-between items-center';
                            
                            const formattedDate = `${needDate.toLocaleDateString()} ${needDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

                            bookingItem.innerHTML = `
                                <div>
                                    <p class="font-semibold text-blue-700">${need.description} <span class="text-sm text-gray-600">for ${pet.name}</span></p>
                                    <p class="text-xs text-gray-500">With: ${provider ? provider.name : 'Unknown Provider'}</p>
                                    <p class="text-xs text-gray-500">On: ${formattedDate} (${need.status || 'Pending'})</p>
                                </div>
                                <button onclick="viewPetDetails('${pet.id}')" class="text-xs bg-blue-100 text-blue-700 hover:bg-blue-200 px-2 py-1 rounded-md">View Pet</button>
                            `;
                            bookingsListContainer.appendChild(bookingItem);
                        }
                    });
                }
            });

            noBookingsMessage.classList.toggle('hidden', hasBookings);
        }

        // Render Pet History List
        function renderPetHistoryList() {
            petHistoryListContainer.innerHTML = '';
            let hasHistory = false;
            const now = new Date();
            let allPastNeeds = [];

            pets.forEach(pet => {
                if (pet.needs && pet.needs.length > 0) {
                    pet.needs.forEach(need => {
                        const needDate = new Date(need.date);
                        // Show if the date is in the past
                        if (needDate <= now) {
                            allPastNeeds.push({ ...need, petName: pet.name, petId: pet.id });
                        }
                    });
                }
            });

            // Sort all past needs by date, most recent first
            allPastNeeds.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allPastNeeds.length > 0) hasHistory = true;

            allPastNeeds.forEach(need => {
                const provider = serviceProviders.find(p => p.id === need.providerId);
                const historyItem = document.createElement('div');
                historyItem.className = 'list-item flex justify-between items-center';
                
                const needDate = new Date(need.date);
                const formattedDate = `${needDate.toLocaleDateString()} ${needDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;

                historyItem.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-700">${need.description} <span class="text-sm text-gray-600">for ${need.petName}</span></p>
                        ${provider ? `<p class="text-xs text-gray-500">With: ${provider.name}</p>` : ''}
                        <p class="text-xs text-gray-500">On: ${formattedDate} (${need.status || 'Completed'})</p>
                    </div>
                     <button onclick="viewPetDetails('${need.petId}')" class="text-xs bg-gray-100 text-gray-700 hover:bg-gray-200 px-2 py-1 rounded-md">View Pet</button>
                `;
                petHistoryListContainer.appendChild(historyItem);
            });

            noHistoryMessage.classList.toggle('hidden', hasHistory);
        }


        // --- Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            let storedPets = localStorage.getItem('pets');
            if (!storedPets || JSON.parse(storedPets).length === 0) {
                // Initialize with sample pets if localStorage is empty or has no pets
                pets = JSON.parse(JSON.stringify(samplePets)); // Deep copy sample pets
                savePets(); 
            } else {
                pets = JSON.parse(storedPets);
            }
            
            showSection('myPets'); 
            renderPetsList();
            renderProviders();
            renderBookingsList(); 
            renderPetHistoryList(); 

            // Close modals with Escape key
            document.addEventListener('keydown', function (event) {
                if (event.key === "Escape") {
                    if (sections.petDetails.classList.contains('show')) {
                        closePetDetails();
                    }
                    if (messageModal.classList.contains('show')) {
                        closeMessageModal();
                    }
                    if (confirmationModal.classList.contains('show')) {
                        closeConfirmationModal();
                    }
                }
            });
        });

    </script>
</body>
</html>
